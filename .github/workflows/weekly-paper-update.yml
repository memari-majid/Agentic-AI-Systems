name: Weekly Paper Update

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-paper:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests beautifulsoup4 python-dateutil pyyaml
      
      - name: Search for new papers
        id: search
        run: |
          python scripts/search_new_papers.py --days 7 --output new_papers_weekly.md
          echo "papers_found=$(grep -c '^##' new_papers_weekly.md || echo '0')" >> $GITHUB_OUTPUT
      
      - name: Update paper version
        run: |
          python scripts/update_paper_version.py
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --exit-code; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push updates
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -A
          git commit -m "ðŸ¤– Weekly paper update - $(date +'%Y-%m-%d')

- Updated paper version and last modified date
- Searched for new papers (last 7 days)
- See new_papers_weekly.md for findings

[skip ci]" || exit 0
          git push origin main
      
      - name: Deploy updated documentation
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          mkdocs gh-deploy --force
      
      - name: Create update summary
        if: always()
        run: |
          cat > update_summary.md << EOF
          # Weekly Paper Update Summary
          
          **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Workflow**: Weekly Paper Update
          
          ## Results
          
          - **New Papers Found**: ${{ steps.search.outputs.papers_found }}
          - **Version Updated**: âœ…
          - **Documentation Deployed**: ${{ steps.changes.outputs.has_changes == 'true' && 'âœ…' || 'â­ï¸ No changes' }}
          
          ## New Papers Report
          
          $(cat new_papers_weekly.md 2>/dev/null || echo 'No new papers found this week.')
          
          ---
          
          *This update was automatically generated by GitHub Actions.*
          EOF
      
      - name: Get current date
        id: date
        run: echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weekly-update-${{ steps.date.outputs.date }}
          path: |
            new_papers_weekly.md
            update_summary.md
          retention-days: 30
      
      - name: Create or update issue
        if: steps.search.outputs.papers_found != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const date = new Date().toISOString().split('T')[0];
            
            let reportContent = '';
            if (fs.existsSync('new_papers_weekly.md')) {
              reportContent = fs.readFileSync('new_papers_weekly.md', 'utf8');
            }
            
            if (fs.existsSync('update_summary.md')) {
              reportContent = fs.readFileSync('update_summary.md', 'utf8');
            }
            
            // Find existing weekly update issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['weekly-update', 'paper-review'],
              state: 'open',
              per_page: 1
            });
            
            const title = `ðŸ“š Weekly Paper Update - ${date}`;
            const body = `${reportContent}\n\n---\n\n*This issue was automatically created by the weekly paper update workflow.*`;
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                title: title,
                body: body
              });
              console.log(`Updated existing issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['weekly-update', 'paper-review', 'automated']
              });
              console.log(`Created new issue #${issue.data.number}`);
            }

